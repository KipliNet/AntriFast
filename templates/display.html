<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Display Antrian - {{ umkm.name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body {
            background: radial-gradient(circle at top, #1f2933, #020617);
            color: #f9fafb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .current-number {
            font-size: clamp(3.5rem, 6vw, 7.5rem);
            line-height: 1;
        }
        .current-name {
            font-size: clamp(1rem, 1.8vw, 2rem);
        }
        .waiting-number {
            font-size: clamp(0.9rem, 1.4vw, 1.2rem);
        }
        .waiting-label {
            font-size: clamp(0.8rem, 1.2vw, 1.1rem);
        }
        .clock-text {
            font-size: clamp(1.1rem, 2.1vw, 2.1rem);
        }
        .clock-sub {
            font-size: clamp(0.7rem, 1.1vw, 1rem);
        }

        .ticker-wrap {
            overflow: hidden;
            position: relative;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 25s linear infinite;
            font-size: clamp(0.9rem, 1.4vw, 1.3rem);
        }
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .fade-enter {
            opacity: 0;
        }
        .fade-enter-active {
            opacity: 1;
            transition: opacity 0.7s ease-in-out;
        }

        /* âœ… FIX: area media tinggi tetap & konten di-crop */
        #media-container {
            height: 80vh;              /* tinggi konsisten */
            max-height: 80vh;
        }
        .media-content {
            width: 100%;
            height: 100%;
            object-fit: cover;        /* crop sesuai area */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header: nama UMKM + jam -->
    <header class="px-4 md:px-8 pt-4 pb-2 flex items-center justify-between">
  <div>
    <!-- Judul: logo + teks sejajar -->
    <div class="flex items-center gap-3">
      <svg class="shrink-0 w-10 h-10 md:w-12 md:h-12"
           xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 140"
           aria-label="AntriFast Logo">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#3B82F6"/>
            <stop offset="1" stop-color="#34D399"/>
          </linearGradient>
        </defs>
        <circle cx="70" cy="70" r="48" fill="none" stroke="url(#g)" stroke-width="16"
                stroke-linecap="round" stroke-dasharray="250 55" transform="rotate(-28 70 70)"/>
        <path d="M98 98 L124 124" stroke="url(#g)" stroke-width="16" stroke-linecap="round"/>
        <circle cx="54" cy="54" r="7" fill="#34D399"/>
      </svg>

      <h1 class="text-xl md:text-3xl font-bold tracking-wide leading-none">
        AntriFast - {{ umkm.name }}
      </h1>
    </div>

    <p class="text-[11px] md:text-xs text-zinc-400 mt-1">
      Mode Kiosk â€¢ Gunakan layar penuh (F11) untuk tampilan terbaik.
    </p>
  </div>

  <div class="text-right leading-tight">
    <p id="clock-time" class="clock-text font-semibold text-emerald-300">
      --:--
    </p>
    <p id="clock-date" class="clock-sub text-zinc-400">
      --
    </p>
  </div>
</header>


    <!-- Konten utama: 2 kolom (kiri info, kanan media) -->
    <main class="flex-1 px-4 md:px-8 pb-4">
        <section class="flex flex-col md:flex-row gap-4 md:gap-6 h-full">

            <!-- Kolom kiri: 25% (3 baris) -->
            <div class="w-full md:w-1/4 flex flex-col gap-4">

                <!-- Sedang dipanggil -->
                <div class="bg-zinc-950/80 border border-zinc-800 rounded-2xl p-4 md:p-5 flex flex-col items-center justify-center text-center">
                    <p class="text-xs md:text-sm text-zinc-400 mb-1 md:mb-2">Sedang dipanggil</p>
                    <p id="display-number" class="current-number font-extrabold text-emerald-400 tracking-widest drop-shadow-lg">
                        {% if current_called %}
                            {{ current_called.queue_number }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p id="display-name" class="current-name text-zinc-200 mt-2 md:mt-3">
                        {% if current_called %}
                            {{ current_called.customer_name or 'Pelanggan berikutnya' }}
                        {% else %}
                            Menunggu antrian pertama...
                        {% endif %}
                    </p>

                    <button id="enable-sound"
                            class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 text-[10px] md:text-[11px] rounded-full border border-emerald-500/60 text-emerald-300 hover:bg-emerald-500/10">
                        ðŸ”Š Aktifkan Suara & Panggilan
                    </button>
                </div>

                <!-- Antrian menunggu (jumlah) -->
                <div class="bg-zinc-950/70 border border-zinc-800 rounded-2xl p-3 md:p-4">
                    <p class="waiting-label text-zinc-400 mb-1">Antrian menunggu</p>
                    <p id="waiting-count" class="text-3xl md:text-4xl font-semibold text-blue-400">
                        {{ waiting|length }}
                    </p>
                </div>

                <!-- Berikutnya (list pendek) -->
                <div class="bg-zinc-950/70 border border-zinc-800 rounded-2xl p-3 md:p-4 flex-1 flex flex-col">
                    <p class="waiting-label text-zinc-400 mb-2">Berikutnya</p>
                    <div id="next-list" class="space-y-1 text-sm md:text-base text-zinc-200">
                        {% for q in waiting[:5] %}
                            <div class="flex justify-between waiting-number">
                                <span>#{{ q.queue_number }}</span>
                                <span class="truncate max-w-[60%]">{{ q.customer_name or 'Tanpa Nama' }}</span>
                            </div>
                        {% endfor %}
                        {% if waiting|length == 0 %}
                            <div class="waiting-number">-</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Kolom kanan: 75% (media promo besar, tinggi tetap) -->
            <div class="w-full md:w-3/4">
                <div id="media-container"
                     class="w-full bg-black/70 border border-zinc-800 rounded-2xl overflow-hidden flex items-center justify-center">
                    <span class="text-xs md:text-sm text-zinc-500">
                        Atur gambar/video promo di halaman Pengaturan.
                    </span>
                </div>
            </div>

        </section>
    </main>

    <!-- Ticker bawah -->
    <footer class="border-t border-zinc-800 py-2 md:py-3 bg-black/80">
        <div class="ticker-wrap">
            <div class="ticker text-zinc-300 px-4">
                {{ ticker }}
            </div>
        </div>
    </footer>

    <!-- Audio beep -->
    <audio id="display-sound">
        <source src="{{ url_for('static', filename='sounds/call.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const slug = "{{ umkm.slug }}";
            const socket = io();

            const numberEl = document.getElementById("display-number");
            const nameEl = document.getElementById("display-name");
            const waitingCountEl = document.getElementById("waiting-count");
            const waitingListEl = document.getElementById("next-list");
            const sound = document.getElementById("display-sound");
            const enableBtn = document.getElementById("enable-sound");
            const mediaContainer = document.getElementById("media-container");
            const clockTimeEl = document.getElementById("clock-time");
            const clockDateEl = document.getElementById("clock-date");

            let lastNumber = {% if current_called %}{{ current_called.queue_number }}{% else %}null{% endif %};
            let lastName = {% if current_called %}"{{ current_called.customer_name or 'Pelanggan berikutnya' }}"{% else %}null{% endif %};
            let soundEnabled = false;

            // === JAM SEKARANG (waktu lokal perangkat display) ===
            function updateClock() {
                const now = new Date();
                const optsTime = { hour: "2-digit", minute: "2-digit", second: "2-digit" };
                const optsDate = { weekday: "long", year: "numeric", month: "long", day: "numeric" };

                clockTimeEl.textContent = now.toLocaleTimeString("id-ID", optsTime);
                clockDateEl.textContent = now.toLocaleDateString("id-ID", optsDate);
            }
            updateClock();
            setInterval(updateClock, 1000);

            // === Media slideshow (kolom kanan) ===
            const images = {{ images|tojson }};
            const videos = {{ videos|tojson }};

            const playlist = [];
            videos.forEach(v => playlist.push({ type: "video", path: v }));
            images.forEach(i => playlist.push({ type: "image", path: i }));

            let slideIndex = 0;
            const SLIDE_DURATION = 10000; // 10 detik per slide untuk GAMBAR
            let slideTimeout = null;      // untuk timer gambar

            function nextSlide() {
                if (playlist.length <= 1) return;
                slideIndex = (slideIndex + 1) % playlist.length;
                renderSlide();
            }

            function renderSlide() {
                // Bersihkan timer lama kalau ada
                if (slideTimeout) {
                    clearTimeout(slideTimeout);
                    slideTimeout = null;
                }

                mediaContainer.innerHTML = "";

                if (playlist.length === 0) {
                    const span = document.createElement("span");
                    span.className = "text-xs md:text-sm text-zinc-500";
                    span.textContent = "Atur gambar/video promo di halaman Pengaturan.";
                    mediaContainer.appendChild(span);
                    return;
                }

                if (slideIndex >= playlist.length) slideIndex = 0;
                const current = playlist[slideIndex];
                const srcBase = "{{ url_for('static', filename='') }}";
                const src = srcBase + current.path;

                let el;
                if (current.type === "video") {
                    el = document.createElement("video");
                    el.src = src;
                    el.autoplay = true;
                    el.muted = true;
                    el.playsInline = true;
                    // âŒ JANGAN di-loop, supaya event "ended" terpanggil
                    // el.loop = true;
                } else {
                    el = document.createElement("img");
                    el.src = src;
                }

                // gunakan kelas konsisten agar selalu crop/cocok ke area
                el.classList.add("media-content", "fade-enter");
                mediaContainer.appendChild(el);

                requestAnimationFrame(() => {
                    el.classList.add("fade-enter-active");
                });

                // ðŸ” Atur pergantian slide:
                if (playlist.length > 1) {
                    if (current.type === "image") {
                        // Gambar: ganti setelah 10 detik
                        slideTimeout = setTimeout(nextSlide, SLIDE_DURATION);
                    } else if (current.type === "video") {
                        // Video: ganti SETELAH video selesai diputar
                        const handleEnded = () => {
                            el.removeEventListener("ended", handleEnded);
                            nextSlide();
                        };
                        el.addEventListener("ended", handleEnded);
                    }
                }
            }

            // mulai slideshow
            renderSlide();

            // if (playlist.length > 1) {
            //     setInterval(() => {
            //         slideIndex = (slideIndex + 1) % playlist.length;
            //         renderSlide();
            //     }, SLIDE_DURATION);
            // }

            // === Suara & TTS ===
            enableBtn.addEventListener("click", () => {
                soundEnabled = true;
                enableBtn.textContent = "ðŸ”Š Suara aktif";
                try {
                    sound.currentTime = 0;
                    sound.play();
                } catch (e) {}
                speakText("Suara antrian aktif.");
            });

            function speakText(text) {
                if (!soundEnabled) return;
                if (!("speechSynthesis" in window)) return;

                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = "id-ID";
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utter);
            }

            // === Socket.IO: update antrian real-time ===
            socket.on("connect", () => {
                socket.emit("join_display", {room: slug});
            });

            socket.on("queue_update", (data) => {
                if (data.current_called) {
                    const newNumber = data.current_called.number;
                    const newName = data.current_called.name || "Pelanggan berikutnya";

                    numberEl.textContent = newNumber;
                    nameEl.textContent = newName;

                    if (lastNumber === null || newNumber !== lastNumber) {
                        if (soundEnabled) {
                            try {
                                sound.currentTime = 0;
                                sound.play();
                            } catch (e) {}
                            const ttsText = `Nomor antrian, ${newNumber}, atas nama ${newName}. Silakan menuju loket.`;
                            speakText(ttsText);
                        }
                        lastNumber = newNumber;
                        lastName = newName;
                    }
                } else {
                    numberEl.textContent = "-";
                    nameEl.textContent = "Menunggu antrian pertama...";
                    lastNumber = null;
                    lastName = null;
                }

                const waiting = data.waiting || [];
                waitingCountEl.textContent = waiting.length;

                // Update "Berikutnya" (max 5)
                waitingListEl.innerHTML = "";
                if (waiting.length === 0) {
                    waitingListEl.innerHTML = "<div class='waiting-number'>-</div>";
                } else {
                    waiting.slice(0, 5).forEach(item => {
                        const div = document.createElement("div");
                        div.className = "flex justify-between waiting-number";
                        div.innerHTML = `<span>#${item.number}</span><span class="truncate max-w-[60%]">${item.name || "Tanpa Nama"}</span>`;
                        waitingListEl.appendChild(div);
                    });
                }
            });
        });
    </script>

</body>
</html>
