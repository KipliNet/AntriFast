<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>{{ umkm.name }} - Antrian</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- PWA manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#020617" />

    <style>
        body {
            background: radial-gradient(circle at top, #020617, #000 70%);
            color: #f9fafb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(14px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- HEADER SEDERHANA -->
    <header class="border-b border-zinc-800/70 bg-black/60">
        <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl from-blue-500 to-emerald-400 flex items-center justify-center text-xl">
                    <img src="{{ url_for('static', filename='img/logo.webp') }}" alt="{{ umkm.name }}">
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-semibold leading-snug">
                        {{ umkm.name }}
                    </h1>
                    <p class="text-[11px] text-zinc-400">
                        Ambil nomor antrian & pantau giliran dari HP Anda
                    </p>
                </div>
            </div>

            <div class="hidden md:flex items-center gap-2 text-[11px] text-zinc-400">
                <span id="realtime-indicator"
                      class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/60 text-emerald-200">
                    ‚óè Live update aktif
                </span>
            </div>
        </div>
    </header>

    {% set my_ticket = new_ticket %}

    <!-- KONTEN UTAMA -->
    <main class="flex-1">
        <section class="max-w-3xl mx-auto px-4 py-6 md:py-8"
                 x-data="{ tab: '{{ 'status' if my_ticket else 'ambil' }}' }">

            <!-- Info bar atas -->
            <div class="mb-5 flex items-center justify-between gap-3">
                <div>
                    <p class="text-xs text-zinc-400">Lokasi antrian</p>
                    <p class="text-sm font-semibold">UMKM {{ umkm.name }}</p>
                </div>
                <div class="hidden sm:flex items-center gap-2 text-[11px] text-zinc-400">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-zinc-900 border border-zinc-800">
                        üì± Bisa ditambahkan ke Home Screen
                    </span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 mb-5 text-xs">
                <button
                    class="flex-1 px-3 py-2 rounded-full border text-center"
                    :class="tab === 'status'
                            ? 'border-emerald-500 bg-emerald-500/10 text-emerald-200'
                            : 'border-zinc-700 bg-zinc-900 text-zinc-300'"
                    @click="tab = 'status'">
                    üì¢ Status Antrian
                </button>
                <button
                    class="flex-1 px-3 py-2 rounded-full border text-center"
                    :class="tab === 'ambil'
                            ? 'border-blue-500 bg-blue-500/10 text-blue-200'
                            : 'border-zinc-700 bg-zinc-900 text-zinc-300'"
                    @click="tab = 'ambil'">
                    üéüÔ∏è Ambil Nomor
                </button>
            </div>

            <!-- GRID: STATUS & FORM -->
            <div class="grid md:grid-cols-2 gap-6 items-start">

                <!-- PANEL STATUS ANTRIAN -->
                <div id="status-panel"
                     class="glass rounded-2xl border border-zinc-800 p-5 space-y-4"
                     x-show="tab === 'status'" x-cloak>

                    <!-- Nomor sedang dipanggil -->
                    <div>
                        <p class="text-xs text-zinc-400 mb-1">Sedang dipanggil sekarang</p>
                        {% if current_called %}
                            <p id="current-number" class="text-5xl md:text-6xl font-extrabold text-emerald-400 leading-none">
                                {{ current_called.queue_number }}
                            </p>
                        {% else %}
                            <p id="current-number" class="text-5xl md:text-6xl font-extrabold text-emerald-400 leading-none">
                                -
                            </p>
                        {% endif %}

                        <p id="current-info-text" class="text-xs text-zinc-400 mt-2">
                            {% if current_called %}
                                Harap bersiap jika nomor Anda mendekati angka ini.
                            {% else %}
                                Belum ada yang dipanggil. Anda bisa menjadi yang pertama hari ini üôÇ
                            {% endif %}
                        </p>
                    </div>

                    <!-- Ringkasan antrian -->
                    <div class="grid grid-cols-2 gap-3 text-xs text-zinc-300">
                        <div class="bg-zinc-900 rounded-xl p-3 border border-zinc-800">
                            <p class="text-[11px] text-zinc-400 mb-1">Antrian menunggu</p>
                            <p id="waiting-count" class="text-2xl font-semibold text-blue-400">{{ waiting|length }}</p>
                        </div>
                        <div class="bg-zinc-900 rounded-xl p-3 border border-zinc-800">
                            <p class="text-[11px] text-zinc-400 mb-1">Total hari ini</p>
                            <p class="text-2xl font-semibold text-zinc-100">{{ count_today }}</p>
                        </div>
                    </div>

                    <!-- Tiket pengguna (jika ada) -->
                    {% if my_ticket %}
                        <div class="bg-zinc-900 rounded-2xl border border-blue-500/60 p-4 space-y-2">
                            <p class="text-xs text-blue-300 mb-1">Tiket antrian Anda</p>
                            <p class="text-sm text-zinc-300">
                                Simpan nomor ini. Tunjukkan ke petugas saat dipanggil.
                            </p>
                            <p class="text-4xl md:text-5xl font-extrabold text-blue-400 leading-none">
                                {{ my_ticket.queue_number }}
                            </p>

                            <p id="ticket-status-text"
                               class="{% if current_called and my_ticket and (my_ticket.queue_number - current_called.queue_number) == 0 %}text-xs text-emerald-300 mt-2 font-semibold{% else %}text-xs text-zinc-400 mt-2{% endif %}">
                                {% if current_called %}
                                    {% set diff = my_ticket.queue_number - current_called.queue_number %}
                                    {% if diff > 0 %}
                                        Perkiraan giliran: sekitar <span class="font-semibold">{{ diff }}</span> nomor lagi.
                                    {% elif diff == 0 %}
                                        Ini giliran Anda! Segera menuju petugas üôå
                                    {% else %}
                                        Nomor Anda sudah terlewat. Silakan hubungi petugas jika perlu bantuan.
                                    {% endif %}
                                {% else %}
                                    Antrian belum dimulai. Petugas akan memulai panggilan sebentar lagi.
                                {% endif %}
                            </p>

                            <p class="text-[11px] text-zinc-500 mt-1">
                                Tips: Anda bisa menyimpan halaman ini atau kembali menggunakan link yang dikirim via WhatsApp.
                            </p>
                        </div>
                    {% else %}
                        <div class="bg-zinc-900 rounded-2xl border border-zinc-800 p-4 space-y-2 text-xs text-zinc-300">
                            <p>Anda belum mengambil nomor antrian.</p>
                            <p class="text-zinc-400">
                                Gunakan tab <span class="font-semibold">‚ÄúAmbil Nomor‚Äù</span> untuk mendapatkan nomor antrian baru.
                            </p>
                        </div>
                    {% endif %}

                    <div class="text-[11px] text-zinc-500 pt-1">
                        Status antrian akan diperbarui otomatis. Jika koneksi kurang stabil, Anda tetap bisa melakukan refresh manual.
                    </div>
                </div>

                <!-- PANEL FORM AMBIL NOMOR -->
                <div id="form-panel"
                     class="glass rounded-2xl border border-zinc-800 p-5"
                     x-show="tab === 'ambil'" x-cloak>
                    <h2 class="text-lg md:text-xl font-semibold mb-2">Ambil Nomor Antrian üéüÔ∏è</h2>
                    <p class="text-xs text-zinc-400 mb-4">
                        Isi data di bawah (opsional), lalu tekan tombol.
                        Jika mengisi nomor WhatsApp, Anda akan mendapat pesan berisi nomor antrian & pengingat.
                    </p>

                    <form method="POST"
                          action="{{ url_for('take_queue', slug_umkm=umkm.slug) }}"
                          class="space-y-4">

                        <div>
                            <label class="block mb-1 text-xs font-medium text-zinc-200">Nama (opsional)</label>
                            <input name="customer_name"
                                   class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                                   placeholder="Contoh: Budi" />
                        </div>

                        <div>
                            <label class="block mb-1 text-xs font-medium text-zinc-200">Nomor WhatsApp (opsional)</label>
                            <input name="customer_phone"
                                   class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                                   placeholder="62xxxxxxxxxx" />
                            <p class="text-[11px] text-zinc-500 mt-1">
                                Nomor ini digunakan untuk mengirim tiket & pengingat via WhatsApp üí¨
                                <br/>Contoh format: 62xxxxxxxxxx (tanpa +62).
                            </p>
                        </div>

                        <button
                            class="w-full bg-blue-600 hover:bg-blue-500 rounded-lg py-2.5 text-sm font-semibold">
                            Ambil Nomor Sekarang üöÄ
                        </button>
                    </form>

                    {% if my_ticket %}
                        <div class="mt-4 bg-zinc-900 rounded-xl border border-zinc-800 p-3 text-[11px] text-zinc-400">
                            <p class="mb-1">Anda sudah memiliki tiket antrian:</p>
                            <p class="text-sm">
                                Nomor: <span class="font-semibold text-blue-300">{{ my_ticket.queue_number }}</span>
                            </p>
                            <p class="mt-1">
                                Jika Anda ambil lagi, sistem akan membuat tiket baru tambahan.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER RINGKAS / FLOATING INFO TIKET -->
    {% if my_ticket %}
    <!-- <div class="fixed bottom-4 inset-x-0 px-4 md:px-0 pointer-events-none">
        <div class="max-w-3xl mx-auto pointer-events-auto">
            <div class="glass rounded-2xl border border-blue-500/40 px-4 py-3 flex items-center justify-between text-xs md:text-sm">
                <div>
                    <p class="text-[11px] text-blue-300">Tiket Anda</p>
                    <p class="text-sm md:text-base text-zinc-100">
                        Nomor antrian: <span class="font-semibold text-blue-300 text-base md:text-lg">{{ my_ticket.queue_number }}</span>
                    </p>
                </div>
                <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                        class="hidden md:inline-flex text-[11px] text-zinc-300 hover:text-white">
                    Lihat status ‚¨ÜÔ∏è
                </button>
            </div>
        </div>
    </div> -->
    {% endif %}

    <!-- FAB: Install PWA / Add to Home -->
    <button
        id="install-pwa-fab"
        type="button"
        class="fixed bottom-20 right-4 md:right-6 z-40 rounded-full shadow-lg px-4 py-2.5
               flex items-center gap-2 text-xs md:text-sm
               bg-emerald-600 hover:bg-emerald-500 text-white
               transition transform translate-y-24 opacity-0 pointer-events-none">
        <span>‚ûï Install App</span>
    </button>
    <footer class="border-t border-zinc-800/70 bg-black/80 mt-4">
        <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between text-[11px] text-zinc-500">
            <span>Powered by AntriLoka</span>
            <span>Pengelola: {{ umkm.name }}</span>
        </div>
    </footer>

    <!-- GSAP, Service Worker, & WebSocket -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // GSAP animasi awal
            if (window.gsap) {
                gsap.from("#status-panel", {
                    opacity: 0,
                    y: 20,
                    duration: 0.5
                });
                gsap.from("#form-panel", {
                    opacity: 0,
                    y: 20,
                    duration: 0.5,
                    delay: 0.1
                });
            }

            // PWA service worker
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
                    .catch(function (err) {
                        console.log("ServiceWorker registration failed: ", err);
                    });
            }


            // ==== FAB: Install PWA / Add to home ====
            let deferredInstallPrompt = null;
            const installFab = document.getElementById("install-pwa-fab");

            // Sembunyikan FAB jika sudah dalam mode standalone (sudah di-install)
            const isStandalone =
                window.matchMedia && window.matchMedia("(display-mode: standalone)").matches ||
                window.navigator.standalone === true;

            if (isStandalone && installFab) {
                installFab.remove(); // tidak perlu tombol kalau sudah ter-install
            }

            // Event ketika app bisa di-install
            window.addEventListener("beforeinstallprompt", (event) => {
                // block prompt default, simpan event
                event.preventDefault();
                deferredInstallPrompt = event;

                if (!installFab || isStandalone) return;

                // tampilkan FAB
                installFab.classList.remove("translate-y-24", "opacity-0", "pointer-events-none");
            });

            // Klik FAB -> trigger install prompt
            if (installFab) {
                installFab.addEventListener("click", async () => {
                    if (!deferredInstallPrompt) {
                        // fallback kalau event belum ada / tidak support
                        alert("Untuk menambahkan ke Home Screen, gunakan menu browser: 'Add to Home Screen'.");
                        return;
                    }

                    deferredInstallPrompt.prompt();
                    const choiceResult = await deferredInstallPrompt.userChoice;

                    if (choiceResult.outcome === "accepted") {
                        console.log("User accepted A2HS prompt");
                    } else {
                        console.log("User dismissed A2HS prompt");
                    }

                    // Setelah prompt digunakan, reset dan sembunyikan FAB
                    deferredInstallPrompt = null;
                    installFab.classList.add("translate-y-24", "opacity-0", "pointer-events-none");
                });
            }

            // Jika app sudah ter-install, pastikan FAB disembunyikan
            window.addEventListener("appinstalled", () => {
                console.log("PWA installed");
                if (installFab) {
                    installFab.classList.add("translate-y-24", "opacity-0", "pointer-events-none");
                }
                deferredInstallPrompt = null;
            });
            // === WebSocket / Socket.IO realtime antrian ===
            const slug = "{{ umkm.slug }}";
            const myTicketNumber = {% if my_ticket %}{{ my_ticket.queue_number }}{% else %}null{% endif %};

            const currentNumberEl = document.getElementById("current-number");
            const currentInfoEl = document.getElementById("current-info-text");
            const waitingCountEl = document.getElementById("waiting-count");
            const nextListEl = document.getElementById("next-list");
            const ticketStatusEl = document.getElementById("ticket-status-text");
            const realtimeIndicator = document.getElementById("realtime-indicator");

            let socket;

            try {
                socket = io();

                socket.on("connect", () => {
                    socket.emit("join_display", {room: slug}); // pakai room slug sama seperti display
                    if (realtimeIndicator) {
                        realtimeIndicator.textContent = "‚óè Live update aktif";
                        realtimeIndicator.classList.remove("border-zinc-700", "bg-zinc-900");
                        realtimeIndicator.classList.add("border-emerald-500/60", "bg-emerald-500/10", "text-emerald-200");
                    }
                });

                socket.on("disconnect", () => {
                    if (realtimeIndicator) {
                        realtimeIndicator.textContent = "‚óã Live update terputus";
                        realtimeIndicator.classList.remove("border-emerald-500/60", "bg-emerald-500/10", "text-emerald-200");
                        realtimeIndicator.classList.add("border-zinc-700", "bg-zinc-900", "text-zinc-400");
                    }
                });

                socket.on("queue_update", (data) => {
                    const current = data.current_called || null;
                    const waiting = data.waiting || [];

                    // update nomor sedang dipanggil
                    if (currentNumberEl) {
                        if (current) {
                            currentNumberEl.textContent = current.number;
                            if (currentInfoEl) {
                                currentInfoEl.textContent = "Harap bersiap jika nomor Anda mendekati angka ini.";
                            }
                        } else {
                            currentNumberEl.textContent = "-";
                            if (currentInfoEl) {
                                currentInfoEl.textContent = "Belum ada yang dipanggil. Anda bisa menjadi yang pertama hari ini üôÇ";
                            }
                        }
                    }

                    // update jumlah antrian menunggu
                    if (waitingCountEl) {
                        waitingCountEl.textContent = waiting.length;
                    }

                    // update daftar "Berikutnya" (max 5)
                    if (nextListEl) {
                        nextListEl.innerHTML = "";
                        if (waiting.length === 0) {
                            nextListEl.innerHTML = "<div class='waiting-number'>-</div>";
                        } else {
                            waiting.slice(0, 5).forEach(item => {
                                const div = document.createElement("div");
                                div.className = "flex justify-between waiting-number";
                                const name = item.name || "Tanpa Nama";
                                div.innerHTML = `<span>#${item.number}</span><span class="truncate max-w-[60%]">${name}</span>`;
                                nextListEl.appendChild(div);
                            });
                        }
                    }

                    // update status tiket pengguna (berapa nomor lagi, dll)
                    if (ticketStatusEl && myTicketNumber !== null && current) {
                        const diff = myTicketNumber - current.number;
                        if (diff > 0) {
                            ticketStatusEl.innerHTML = `Perkiraan giliran: sekitar <span class="font-semibold">${diff}</span> nomor lagi.`;
                            ticketStatusEl.className = "text-xs text-zinc-400 mt-2";
                        } else if (diff === 0) {
                            ticketStatusEl.textContent = "Ini giliran Anda! Segera menuju petugas üôå";
                            ticketStatusEl.className = "text-xs text-emerald-300 mt-2 font-semibold";
                        } else {
                            ticketStatusEl.textContent = "Nomor Anda sudah terlewat. Silakan hubungi petugas jika perlu bantuan.";
                            ticketStatusEl.className = "text-xs text-zinc-400 mt-2";
                        }
                    }
                });
            } catch (e) {
                console.log("Socket.IO error:", e);
                if (realtimeIndicator) {
                    realtimeIndicator.textContent = "‚óã Live update tidak tersedia";
                    realtimeIndicator.classList.add("text-zinc-400");
                }
            }
        });
    </script>
</body>
</html>
